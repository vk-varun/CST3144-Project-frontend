<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>After School Classes</title>
    <!-- Production Link -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16"></script> -->
    <!-- Prototyping Link -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
    <!-- Font Awesome Link -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="classes.js"></script>

</head>

<body>
    <div id="app">
        <header>
            <h1 v-text="siteName"></h1>
            <!-- Checkout button -->
            <!-- Button disabled if cart empty -->
            <button v-on:click="showCheckout" :disabled="cartItemCount === ''">
                {{ cartItemCount }}
                <!-- <span v-if="cartItemCount > 0">{{ cartItemCount }}</span> -->
                <!-- cart Icon -->
                <span class="fas fa-cart-plus"></span>
                Checkout
            </button>
        </header>
        <main>
            <div class="" v-if="showProduct">
                <input type="search" name="" v-model="searchTerm" id="search-class" placeholder="Search">
                <h2>Classes</h2>

                <div class="classes-section">
                    <!-- Sort Functionality  -->
                    <div class="sort-section">
                        <h3>Sort by</h3>
                        <div class="sort">
                            <label><input type="radio" v-model="sortField" value="title"> Subject</label>
                            <label><input type="radio" v-model="sortField" value="location"> Location</label>
                            <label><input type="radio" v-model="sortField" value="price"> Price</label>
                            <label><input type="radio" v-model="sortField" value="availability"> Availability</label>
                        </div>
                        <h3>Order</h3>
                        <div class="order">
                            <label><input type="radio" v-model="sortOrder" value="asc"> Ascending</label>
                            <label><input type="radio" v-model="sortOrder" value="desc"> Descending</label>
                        </div>
                    </div>

                    <div class="class-list">
                        <!-- <div class="class" v-for="product in classes"> -->
                        <div class="class" v-for="product in sortedClasses">    
                            <figure>
                                <img v-bind:src="product.image">
                            </figure>
                            <h2 v-text="product.title"></h2>
                            <p v-html="product.description"></p>
                            <p><strong>Location:</strong> {{ product.location }}</p>
                            <p><strong>Price:</strong> {{ product.price }}</p>
                            <!-- <p>Availability: {{ product.availableInventory - cartItemCount }}</p> -->
                            <p><strong>Availability:</strong> {{ product.availableInventory - cartCount(product.id) }}</p>
                            <!-- instead of v-on, @ symbol can be used -->
                            <!-- <input type="button" value="add" v-on:click="addToCart">  -->
                            <button v-on:click="addToCart(product)" v-if="canAddToCart(product)">Add to cart</button>
                            <button disabled="disabled" v-else>Out of Stock</button>
        
                            <!-- Updating cartItem to cartCount -->
                            <span v-if="product.availableInventory === cartCount(product.id)">
                                All out!
                            </span>
                            <span v-else-if="product.availableInventory - cartCount(product.id) < 5">
                                Only {{product.availableInventory - cartCount(product.id)}} left!
                            </span>
                            <span class="book-now" v-else>
                                Book now!
                            </span>
            
                            <div>
                                <span v-for="n in product.rating">★</span>
                                <span v-for="n in 5 - product.rating">☆</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                
            </div>

            <div class="checkout-section" v-else>
                <!-- Cart Items -->
                <div class="cart-items">
                    <h2>Cart Items</h2>

                    <div class="class-list">
                        <div class="class" v-for="productId in cartItems" :key="productId">
                            <figure>
                                <img v-bind:src="getClassById(productId).image" alt="Class Image">
                            </figure>
                            <h2 v-text="getClassById(productId).title"></h2>
                            <p><strong>Location:</strong> {{ getClassById(productId).location }}</p>
                            <p><strong>Price:</strong> {{ getClassById(productId).price }}</p>
                            <p><strong>Quantity:</strong> {{ cartCount(productId) }}</p>
                            <button @click="removeFromCart(productId)">Remove</button>
                        </div>
                    </div>

                </div>

                <!-- Checkout -->
                <div class="checkout-section">
                    <h2>Checkout</h2>
                    <div class="checkout">
                        <div class="form">
                            <!-- <p>
                                <strong>First Name:</strong>
                                <input v-model.trim="order.firstName">
                            </p>
                            <p>
                                <strong>Last Name:</strong>
                                <input v-model.trim="order.lastName">
                            </p> -->
                            <p>
                                <strong>Name:</strong>
                                <input v-model.trim="order.name" placeholder="FirstName LastName">
                            </p>
                            <p>
                                <strong>Address:</strong>
                                <input v-model.trim="order.address" placeholder="Street address">
                            </p>
                            <p>
                                <strong>City:</strong>
                                <input v-model.trim="order.city" placeholder="City Name">
                            </p>
                            <!-- <p>
                                <strong>State:</strong>
                                <select v-model="order.state">
                                    <option disabled value="">State</option>
                                    <option v-for="(state, key) in states" 
                                        v-bind:value="state">
                                        {{ key }}
                                    </option>
                                </select>
                            </p> -->
                            <p>
                                <strong>Phone Number:</strong>
                                <input v-model.number="order.phoneNumber" type="number" placeholder="123 456 7890">
                            </p>
                            <!-- Checkbox -->
                            <!-- <p>
                                <input type="checkbox" id="gift" value="true" 
                                    v-model="order.gift"
                                    v-bind:true-value="order.sendGift"
                                    v-bind:false-value="order.dontSendGift">
                                <label for="gift">Ship as Gift?</label>
                            </p> -->
                            <!-- Radio button -->
                            <!-- <p class="radio-button">
                                <input type="radio" id="home" value="Home" v-model="order.method">
                                <label for="home">Home</label>
                                <input type="radio" id="business" value="Business" v-model="order.method">
                                <label for="business">Business</label>
                            </p> -->
        
                            <button v-on:click="submitForm" :disabled="!formValid">Place Order</button>
                        </div>
                        
        
                        <!-- Displays order information and updates in real-time -->
                        <div class="order-info">
                            <h2>Order Information</h2>
                            <!-- <p>First Name: {{ order.firstName }}</p>
                            <p>Last Name: {{ order.lastName }}</p> -->
                            <p>Name: {{ order.name }}</p>
                            <p>Address: {{ order.address }}</p>
                            <p>City: {{ order.city }}</p>
                            <!-- <p>State: {{ order.state }}</p> -->
                            <p>Phone Number: {{ order.phoneNumber }}</p>
                            <!-- <p>Gift? {{ order.gift }}</p>
                            <p>Method: {{ order.method }}</p> -->
                        </div> 
                    </div>
                </div>
                                
            </div>
        </main>
    </div>
    <script type="text/javascript">
        let webstore = new Vue({
            el: "#app", // DOM (Document Object Model) used to mount the application
            data: {
                siteName: "After School Classes",
                // classes: classes,
                classes: [],
                cart: [], // an array to store items in shopping cart
                showProduct: true,
                order: {
                    // firstName: "",
                    // lastName: "",
                    name: "",
                    address: "",
                    city: "",
                    // state: "",
                    phoneNumber: "",
                    // gift: false,
                    // method: "Home",
                    // sendGift: "Send as a gift",
                    // dontSendGift: "Do not send as a gift"
                },
                // states: {
                //     AL: "Alabama",
                //     AZ: "Arizona",
                //     CA: "California",
                //     NV: "Nevada"
                // },
                sortField: "title",
                sortOrder: "asc",
                searchTerm: "",
                searchResults: []
            },
            created: function () {
                console.log('Requesting data from server ...')
                
                // fetch data from server
                fetch('http://localhost:3000/collection/Classes', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(responseJSON => {
                        // save the returned JSON object to 'classes'
                        this.classes = responseJSON;
                        console.log(responseJSON);
                    })
                    .catch((error) => {
                        console.log(error);
                    });
            },
            methods: {
                addToCart: function (product) {
                    this.cart.push(product.id);
                    // this.product.availableInventory -= 1;
                },
                // Moved from computed
                canAddToCart: function (product) {
                    return product.availableInventory > this.cartCount(product.id);
                    // return this.product.availableInventory > 0;
                },
                // New method to count cart items
                // ->Imp<-
                cartCount (id) {
                    let count = 0;
                    for (let i = 0; i < this.cart.length; i++) {
                        if (this.cart[i] === id) {
                            count++;
                        }
                    }
                    return count;
                },
                showCheckout() {
                    this.showProduct = this.showProduct ? false : true;
                },
                submitForm() {
                    // // TODO: check validity of name and phone number
                    // // check done using regular expression

                    // let nameTest = /^[a-zA-Z ]{2,30}$/;
                    // let phoneTest = /^\d{10}$/;

                    // if (!nameTest.test(this.order.name)) {
                    //     alert("Please enter a valid name. Letters only must be 2 to 30 characters long");
                    //     return;
                    // }
                    // if (!phoneTest.test(this.order.phoneNumber)) {
                    //     alert("Phone number must be 10 digits");
                    //     return;
                    // } 

                    // alert("Order Submitted!");

                    // object to store order details and cart items
                    let orderDetails = {
                        name: this.order.name,
                        phoneNumber: this.order.phoneNumber,
                        cart: this.cartItems.map(productId => {
                            let product = this.getClassById(productId);
                            return {
                                id: productId,
                                title: product.title,
                                price: product.price,
                                quantity: this.cartCount(productId)
                            };
                        })
                    };

                    // send order details to server
                    fetch('http://localhost:3000/collection/Orders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json', // set the data type as JSON
                        },
                        body: JSON.stringify(orderDetails),   // stringify the JSON object
                    })
                        .then(response => response.json())
                        .then(responseJSON => {
                            alert("Order Submitted!");
                            console.log(responseJSON);
                            // clear the cart and order information
                            this.cart = [];
                            this.order = {
                                name: "",
                                phoneNumber: ""
                            };
                            this.showProduct = true;
                        })
                        .catch((error) => {
                            console.log(error);
                        });
                },
                getClassById (id) {
                    return this.classes.find(product => product.id === id);
                },
                removeFromCart: function (productId) {
                    // TODO: remove class from cart
                    // find the position where the class is stored 
                    let index = this.cart.indexOf(productId);

                    // remove the class from the cart
                    this.cart.splice(index, 1);

                    // return to classes page if the cart is empty
                    if (this.cartItemCount === "") {
                        this.showProduct = true;
                    }
                },
                searchClasses () {
                    // Search filter Functionality
                    // filter cart based on searchTerm
                    let searchResults = [];
                    for (let product of this.classes) {
                        if (
                            product.title.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                            product.location.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                            product.price.toString().includes(this.searchTerm.toLowerCase()) ||
                            (product.availableInventory - this.cartCount(product.id)).toString().includes(this.searchTerm.toLowerCase())
                        ) {
                            searchResults.push(product);
                        }
                    }
                    return searchResults;
                }
            },
            computed: {
                cartItemCount: function () {
                    // its value is calculated each time its called
                    return this.cart.length || "";
                },
                
                itemsLeft() {
                    return this.product.availableInventory - this.cartItemCount;
                },
                
                cartItems() {
                    // TODO: show classes added to cart
                    // array without duplicate classes 
                    return [...new Set(this.cart)];
                },

                sortedClasses() {
                    
                    // Search filter Functionality
                    // TODO: add search with price & availability 
                    const filteredClasses = this.classes.filter(product => {
                        return product.title.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                            product.location.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                            product.price.toString().includes(this.searchTerm.toLowerCase()) ||
                            (product.availableInventory - this.cartCount(product.id)).toString().includes(this.searchTerm.toLowerCase());
                    });

                    // Sort Filter Functionality
                    // compare function that defines the order
                    function compare(a, b) {
                        let modifier = this.sortOrder === "asc" ? 1 : -1;

                        if (this.sortField === "price") {
                            return (a.price - b.price) * modifier;
                        } else if (this.sortField === "title") {
                            return a.title.localeCompare(b.title) * modifier;
                        } else if (this.sortField === "location") {
                            return a.location.localeCompare(b.location) * modifier;
                        } else if (this.sortField === "availability") {
                            return ((a.availableInventory - this.cartCount(a.id)) - (b.availableInventory - this.cartCount(b.id))) * modifier;
                        }
                        return 0;
                    }

                    // Return 'filteredClasses' array with the sorted products
                    // return filteredClasses.sort(compare.bind(this));
                    // let searchClasses = this.searchClasses()
                    return this.searchClasses().sort(compare.bind(this));
                    // return filteredClasses.slice().sort(compare.bind(this));
                    
                },

                formValid() {
                    // TODO: check validity of name and phone number
                    // check done using regular expression

                    let nameTest = /^[a-zA-Z ]{2,30}$/;
                    let phoneTest = /^\d{10}$/;

                    return nameTest.test(this.order.name) && 
                        phoneTest.test(this.order.phoneNumber) &&
                        this.order.name &&
                        this.order.phoneNumber;

                }
            }

        });
    </script>
</body>

</html>